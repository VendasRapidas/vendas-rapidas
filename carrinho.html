<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Carrinho</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .carrinho-container {
      padding: 20px;
    }

    .produto-carrinho {
      display: flex;
      align-items: center;
      gap: 15px;
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }

    .produto-carrinho img {
      width: 80px;
      height: auto;
      border-radius: 4px;
    }

    .produto-carrinho h3 {
      margin: 0;
      font-size: 1.1rem;
    }

    .produto-carrinho p {
      margin: 5px 0;
    }

    .remover-btn {
      background-color: red;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: auto;
    }

    .remover-btn:hover {
      background-color: darkred;
    }

    .total {
      font-weight: bold;
      margin-top: 20px;
      font-size: 1.2rem;
    }

    .checkout-btn {
      margin-top: 20px;
      padding: 10px 15px;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 4px;
      border: none;
      background-color: #28a745;
      color: white;
    }

    .checkout-btn:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>
  <header>
    <h1>O teu Carrinho</h1>
    <nav>
      <a href="index.html">Home</a> |
      <a href="produtos.html">Produtos</a> |
      <a href="carrinho.html">Carrinho</a> |
      <a href="sobre.html">Sobre Nós</a>
    </nav>
  </header>

  <main class="carrinho-container">
    <div id="carrinho-itens"></div>
    <div class="total" id="carrinho-total"></div>
    <button class="checkout-btn" id="checkout-btn">Finalizar Compra</button>
  </main>

  <script>
    const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
    const container = document.getElementById("carrinho-itens");
    const totalDiv = document.getElementById("carrinho-total");

    function atualizarCarrinho() {
      container.innerHTML = "";
      let total = 0;

      carrinho.forEach((item, index) => {
        const subtotal = item.preco * item.quantidade;
        total += subtotal;

        const div = document.createElement("div");
        div.className = "produto-carrinho";
        div.innerHTML = `
          <img src="${item.imagem}" alt="${item.nome}" />
          <div>
            <h3>${item.nome}${item.cor ? ` (${item.cor})` : ""}</h3>
            <p>Preço: €${item.preco.toFixed(2)}</p>
            <p>Quantidade: ${item.quantidade}</p>
            <p>Subtotal: €${subtotal.toFixed(2)}</p>
          </div>
          <button class="remover-btn" data-index="${index}">Remover</button>
        `;
        container.appendChild(div);
      });

      totalDiv.textContent = `Total: €${total.toFixed(2)}`;
    }

    container.addEventListener("click", (e) => {
      if (e.target.classList.contains("remover-btn")) {
        const index = e.target.getAttribute("data-index");
        carrinho.splice(index, 1);
        localStorage.setItem("carrinho", JSON.stringify(carrinho));
        atualizarCarrinho();
      }
    });

    document.getElementById("checkout-btn").addEventListener("click", () => {
      if (carrinho.length === 0) {
        alert("O carrinho está vazio!");
        return;
      }

      const stripeItems = carrinho.map((item) => ({
        name: item.nome + (item.cor ? ` (${item.cor})` : ""),
        price: Math.round(item.preco * 100),
        quantity: item.quantidade
      }));

      fetch("/.netlify/functions/create-checkout-session", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ items: stripeItems })
      })
      .then((res) => res.json())
      .then((data) => {
        if (data.id) {
          window.location.href = `https://checkout.stripe.com/pay/${data.id}`;
        } else {
          alert("Erro ao redirecionar para Stripe.");
        }
      })
      .catch((err) => {
        console.error(err);
        alert("Erro ao criar sessão de pagamento.");
      });
    });

    atualizarCarrinho();
  </script>
</body>
</html>
